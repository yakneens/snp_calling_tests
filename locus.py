import sys
from math import log10

q_chars = ['!', '"', '#', '$', '%', '&', "'", '(', ')', '*', '+', ',', '-', '.', '/', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', ':', ';', '<', '=', '>', '?', '@', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H']
q_chars_to_qual = {'!': 0, '#': 2, '"': 1, '%': 4, '$': 3, "'": 6, '&': 5, ')': 8, '(': 7, '+': 10, '*': 9, '-': 12, ',': 11, '/': 14, '.': 13, '1': 16, '0': 15, '3': 18, '2': 17, '5': 20, '4': 19, '7': 22, '6': 21, '9': 24, '8': 23, ';': 26, ':': 25, '=': 28, '<': 27, '?': 30, '>': 29, 'A': 32, '@': 31, 'C': 34, 'B': 33, 'E': 36, 'D': 35, 'G': 38, 'F': 37, 'H': 39}


p_errors = [1.0, 0.7943282347242815, 0.6309573444801932, 0.5011872336272722, 0.3981071705534972, 0.31622776601683794, 0.251188643150958, 0.19952623149688797, 0.15848931924611134, 0.12589254117941673, 0.1, 0.07943282347242814, 0.06309573444801933, 0.05011872336272722, 0.039810717055349734, 0.03162277660168379, 0.025118864315095794, 0.0199526231496888, 0.015848931924611134, 0.012589254117941675, 0.01, 0.007943282347242814, 0.00630957344480193, 0.005011872336272725, 0.003981071705534973, 0.0031622776601683794, 0.0025118864315095794, 0.001995262314968879, 0.001584893192461114, 0.0012589254117941675, 0.001, 0.0007943282347242813, 0.000630957344480193, 0.0005011872336272725, 0.00039810717055349735, 0.00031622776601683794, 0.00025118864315095795, 0.00019952623149688788, 0.00015848931924611142, 0.00012589254117941674]
q_chars_to_p_errors = {'!': 1.0, '#': 0.6309573444801932, '"': 0.7943282347242815, '%': 0.3981071705534972, '$': 0.5011872336272722, "'": 0.251188643150958, '&': 0.31622776601683794, ')': 0.15848931924611134, '(': 0.19952623149688797, '+': 0.1, '*': 0.12589254117941673, '-': 0.06309573444801933, ',': 0.07943282347242814, '/': 0.039810717055349734, '.': 0.05011872336272722, '1': 0.025118864315095794, '0': 0.03162277660168379, '3': 0.015848931924611134, '2': 0.0199526231496888, '5': 0.01, '4': 0.012589254117941675, '7': 0.00630957344480193, '6': 0.007943282347242814, '9': 0.003981071705534973, '8': 0.005011872336272725, ';': 0.0025118864315095794, ':': 0.0031622776601683794, '=': 0.001584893192461114, '<': 0.001995262314968879, '?': 0.001, '>': 0.0012589254117941675, 'A': 0.000630957344480193, '@': 0.0007943282347242813, 'C': 0.00039810717055349735, 'B': 0.0005011872336272725, 'E': 0.00025118864315095795, 'D': 0.00031622776601683794, 'G': 0.00015848931924611142, 'F': 0.00019952623149688788, 'H': 0.00012589254117941674}

log_p_errors = [0.0, -0.1, -0.2, -0.30000000000000004, -0.4000000000000001, -0.5, -0.6, -0.7, -0.8, -0.9, -1.0, -1.1, -1.2, -1.3, -1.4, -1.5, -1.6, -1.7, -1.8, -1.9, -2.0, -2.1, -2.2, -2.3, -2.4, -2.5, -2.6, -2.7, -2.8, -2.9, -3.0, -3.1, -3.2, -3.3, -3.4, -3.5, -3.6, -3.7, -3.8, -3.9]
q_chars_to_log_p_errors = {'!': 0.0, '#': -0.2, '"': -0.1, '%': -0.4000000000000001, '$': -0.30000000000000004, "'": -0.6, '&': -0.5, ')': -0.8, '(': -0.7, '+': -1.0, '*': -0.9, '-': -1.2, ',': -1.1, '/': -1.4, '.': -1.3, '1': -1.6, '0': -1.5, '3': -1.8, '2': -1.7, '5': -2.0, '4': -1.9, '7': -2.2, '6': -2.1, '9': -2.4, '8': -2.3, ';': -2.6, ':': -2.5, '=': -2.8, '<': -2.7, '?': -3.0, '>': -2.9, 'A': -3.2, '@': -3.1, 'C': -3.4, 'B': -3.3, 'E': -3.6, 'D': -3.5, 'G': -3.8, 'F': -3.7, 'H': -3.9}


one_minus_p_errors = [0.0, 0.2056717652757185, 0.36904265551980675, 0.49881276637272776, 0.6018928294465028, 0.683772233983162, 0.748811356849042, 0.800473768503112, 0.8415106807538887, 0.8741074588205833, 0.9, 0.9205671765275718, 0.9369042655519807, 0.9498812766372727, 0.9601892829446502, 0.9683772233983162, 0.9748811356849042, 0.9800473768503112, 0.9841510680753889, 0.9874107458820583, 0.99, 0.9920567176527572, 0.993690426555198, 0.9949881276637272, 0.996018928294465, 0.9968377223398316, 0.9974881135684904, 0.9980047376850312, 0.9984151068075389, 0.9987410745882058, 0.999, 0.9992056717652757, 0.9993690426555198, 0.9994988127663728, 0.9996018928294464, 0.9996837722339832, 0.999748811356849, 0.9998004737685031, 0.9998415106807539, 0.9998741074588205]
q_chars_to_one_minus_p_errors = {'!': 0.0, '#': 0.36904265551980675, '"': 0.2056717652757185, '%': 0.6018928294465028, '$': 0.49881276637272776, "'": 0.748811356849042, '&': 0.683772233983162, ')': 0.8415106807538887, '(': 0.800473768503112, '+': 0.9, '*': 0.8741074588205833, '-': 0.9369042655519807, ',': 0.9205671765275718, '/': 0.9601892829446502, '.': 0.9498812766372727, '1': 0.9748811356849042, '0': 0.9683772233983162, '3': 0.9841510680753889, '2': 0.9800473768503112, '5': 0.99, '4': 0.9874107458820583, '7': 0.993690426555198, '6': 0.9920567176527572, '9': 0.996018928294465, '8': 0.9949881276637272, ';': 0.9974881135684904, ':': 0.9968377223398316, '=': 0.9984151068075389, '<': 0.9980047376850312, '?': 0.999, '>': 0.9987410745882058, 'A': 0.9993690426555198, '@': 0.9992056717652757, 'C': 0.9996018928294464, 'B': 0.9994988127663728, 'E': 0.999748811356849, 'D': 0.9996837722339832, 'G': 0.9998415106807539, 'F': 0.9998004737685031, 'H': 0.9998741074588205}


log_one_minus_p_errors = [-0.6868253243801155, -0.4329234333362483, -0.3020624399283004, -0.22048083054190856, -0.16508853862676973, -0.12562757749181508, -0.09665289532620472, -0.07494036743261491, -0.058435173882679825, -0.045757490560675115, -0.035944514242268806, -0.028304783783119625, -0.02233067273579157, -0.017643145673638245, -0.013955433882055845, -0.01104833328923533, -0.008752929402068548, -0.006938231857449642, -0.005502150711903429, -0.004364805402450088, -0.003463497745545996, -0.002748894253840988, -0.0021821012853218097, -0.001732408187017172, -0.0013755357992172792, -0.0010922708215363676, -0.0008673970437087813, -0.0006888563941051661, -0.0005470888037707397, -0.0004345117740176917, -0.0003451094524047399, -0.0002741077772782459, -0.00021771741311715128, -0.00017293017203269027, -0.00013735769310873925, -0.00010910354499669152, -8.666178727149581e-05, -6.883649185765944e-05, -5.4677877787723976e-05]
q_chars_to_log_one_minus_p_errors = {'#': -0.4329234333362483, '"': -0.6868253243801155, '%': -0.22048083054190856, '$': -0.3020624399283004, "'": -0.12562757749181508, '&': -0.16508853862676973, ')': -0.07494036743261491, '(': -0.09665289532620472, '+': -0.045757490560675115, '*': -0.058435173882679825, '-': -0.028304783783119625, ',': -0.035944514242268806, '/': -0.017643145673638245, '.': -0.02233067273579157, '1': -0.01104833328923533, '0': -0.013955433882055845, '3': -0.006938231857449642, '2': -0.008752929402068548, '5': -0.004364805402450088, '4': -0.005502150711903429, '7': -0.002748894253840988, '6': -0.003463497745545996, '9': -0.001732408187017172, '8': -0.0021821012853218097, ';': -0.0010922708215363676, ':': -0.0013755357992172792, '=': -0.0006888563941051661, '<': -0.0008673970437087813, '?': -0.0004345117740176917, '>': -0.0005470888037707397, 'A': -0.0002741077772782459, '@': -0.0003451094524047399, 'C': -0.00017293017203269027, 'B': -0.00021771741311715128, 'E': -0.00010910354499669152, 'D': -0.00013735769310873925, 'G': -6.883649185765944e-05, 'F': -8.666178727149581e-05, 'H': -5.4677877787723976e-05}


class Locus(object):
    MIN_GL = sys.float_info.min

    def __init__(self, pos, ref, alt, gl_ref, gl_het, gl_hom, history):
        self.pos = pos
        self.ref = ref
        self.alt = alt
        self.gl_ref = gl_ref
        self.gl_het = gl_het
        self.gl_hom = gl_hom
        self.history = history
        # Read Depth
        self.dp = 0
        # Reference observation count
        self.ro = 0
        # Sum of reference observation qualities
        self.qr = 0
        self.ao = 0
        # Sum of alternate observation qualities
        self.qa = 0

    def add_to_history(self, new_val):
        self.history.append(new_val)

    def get_gls(self):
        return (self.gl_ref, self.gl_het, self.gl_hom)

    def get_log_gls(self):
        return (log10(self.gl_ref), log10(self.gl_het), log10(self.gl_hom))

    def get_pl(self):
        vals = (int(to_phred(self.gl_ref)), int(to_phred(self.gl_het)), int(to_phred(self.gl_hom)))
        return tuple(map(lambda x: x - min(vals), vals))

    def get_gq(self):
        pl = self.get_pl()
        if (pl[1] == 0):
            return pl[2]
        elif (pl[2] == 0):
            return pl[1]
        else:
            print("Something went wrong in PL calculation")
            exit(1)

    def get_norm_gls(self):
        norm_const = self.gl_ref + self.gl_het + self.gl_hom
        return (self.gl_ref / norm_const, self.gl_het / norm_const, self.gl_hom / norm_const)

    def update_gls_to_min_if_zero(self):
        self.gl_hom = min_gl_if_zero(self.gl_hom)
        self.gl_het = min_gl_if_zero(self.gl_het)
        self.gl_ref = min_gl_if_zero(self.gl_ref)

def to_phred(x):
    return -10*(log10(x))

def from_phred(x):
    return pow(10, -x/10)

def min_gl_if_zero(val):
    if val == 0:
        return Locus.MIN_GL
    else:
        return val